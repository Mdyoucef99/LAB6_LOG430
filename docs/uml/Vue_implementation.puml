@startuml
' Diagramme de packages pour l'architecture microservices avec saga chorégraphiée

package "cart-service" {
  package "domain" {
    class Cart
    class CartItem
    Cart "1" -- "0..*" CartItem
  }
  package "infrastructure" {
    class CartDao
    class CartItemDao
    CartDao ..> Cart
    CartItemDao ..> CartItem
  }
  package "api" {
    class CartController
    CartController ..> Cart
    CartController ..> CartDao
    CartController ..> CartItem
    CartController ..> CartItemDao
  }
  package "service" {
    class CartSagaHandler
    CartSagaHandler ..> Cart
    CartSagaHandler ..> CartDao
  }
  package "config" {
    class CartRabbitMQConfig
  }
  package "application" {
    class CartApplication
  }
}

package "customer-service" {
  package "domain" {
    class Customer
  }
  package "infrastructure" {
    class CustomerDao
    CustomerDao ..> Customer
  }
  package "api" {
    class CustomerRestController
    CustomerRestController ..> Customer
    CustomerRestController ..> CustomerDao
  }
  package "application" {
    class CustomerApplication
  }
}

package "inventory-service" {
  package "domain" {
    class Produit
    class Stock
    class Store
    Stock "*" -- "1" Produit
    Stock "*" -- "1" Store
  }
  package "infrastructure" {
    class StockDao
    class StoreDao
    StockDao ..> Stock
    StoreDao ..> Store
  }
  package "api" {
    class StockRestController
    StockRestController ..> Stock
    StockRestController ..> StockDao
  }
  package "service" {
    class InventorySagaHandler
    InventorySagaHandler ..> Stock
    InventorySagaHandler ..> StockDao
  }
  package "config" {
    class InventoryRabbitMQConfig
  }
  package "application" {
    class InventoryApplication
  }
}

package "product-service" {
  package "domain" {
    class Produit
  }
  package "infrastructure" {
    class ProduitDao
    ProduitDao ..> Produit
  }
  package "api" {
    class ProduitRestController
    ProduitRestController ..> Produit
    ProduitRestController ..> ProduitDao
  }
  package "application" {
    class ProductApplication
  }
}

package "order-service" {
  package "domain" {
    class Order
  }
  package "infrastructure" {
    class OrderDao
    OrderDao ..> Order
  }
  package "api" {
    class OrderController
    OrderController ..> Order
    OrderController ..> OrderDao
  }
  package "service" {
    class OrderSagaHandler
    OrderSagaHandler ..> Order
    OrderSagaHandler ..> OrderDao
  }
  package "config" {
    class OrderRabbitMQConfig
  }
  package "application" {
    class OrderApplication
  }
}

package "saga-orchestrator-service" {
  package "domain" {
    class SagaState
    class OrderRequest
    class OrderItem
    class SagaResult
    OrderRequest "1" -- "0..*" OrderItem
  }
  package "service" {
    class SagaOrchestratorService
    SagaOrchestratorService ..> OrderRequest
    SagaOrchestratorService ..> SagaResult
    SagaOrchestratorService ..> SagaState
  }
  package "api" {
    class SagaController
    SagaController ..> SagaOrchestratorService
    SagaController ..> OrderRequest
    SagaController ..> SagaResult
  }
  package "application" {
    class SagaApplication
  }
}

package "event-store-service" {
  package "domain" {
    class EventStore
  }
  package "infrastructure" {
    class EventStoreDao
    EventStoreDao ..> EventStore
  }
  package "api" {
    class EventStoreRestController
    EventStoreRestController ..> EventStore
    EventStoreRestController ..> EventStoreDao
  }
  package "service" {
    class MetricsService
    MetricsService ..> EventStore
  }
  package "application" {
    class EventStoreApplication
  }
}

package "notification-service" {
  package "domain" {
    class BaseEvent
  }
  package "service" {
    class EventConsumer
    class NotificationService
    EventConsumer ..> BaseEvent
    NotificationService ..> BaseEvent
  }
  package "config" {
    class NotificationRabbitMQConfig
  }
  package "api" {
    class NotificationController
    NotificationController ..> NotificationService
  }
  package "application" {
    class NotificationApplication
  }
}

package "reporting-service" {
  package "domain" {
    class Produit
    class Sale
    class SaleReport
    class Store
    Sale "*" -- "1" Produit
    Sale "*" -- "1" Store
    SaleReport "*" -- "1" Store
  }
  package "infrastructure" {
    class ProduitDao
    class SaleDao
    class StoreDao
    ProduitDao ..> Produit
    SaleDao ..> Sale
    StoreDao ..> Store
  }
  package "api" {
    class ReportRestController
    ReportRestController ..> SaleReport
    ReportRestController ..> SaleDao
    ReportRestController ..> ProduitDao
    ReportRestController ..> StoreDao
  }
  package "application" {
    class ReportingApplication
  }
}

package "api-gateway" {
  class ApiGatewayApplication
}

' Relations entre services pour la saga orchestrée (REST)
SagaOrchestratorService ..> CartController : REST calls
SagaOrchestratorService ..> StockRestController : REST calls
SagaOrchestratorService ..> OrderController : REST calls

' Relations pour la saga chorégraphiée (Events via RabbitMQ)
OrderController ..> CartSagaHandler : OrderStartedEvent
CartSagaHandler ..> InventorySagaHandler : CartValidatedEvent
InventorySagaHandler ..> OrderSagaHandler : StockReservedEvent
OrderSagaHandler ..> CartSagaHandler : OrderCreatedEvent

' Event Store - Stockage de tous les événements
CartSagaHandler ..> EventStoreRestController : Store events
InventorySagaHandler ..> EventStoreRestController : Store events
OrderSagaHandler ..> EventStoreRestController : Store events

' Notification Service - Écoute des événements
EventConsumer ..> CartSagaHandler : Listen events
EventConsumer ..> InventorySagaHandler : Listen events
EventConsumer ..> OrderSagaHandler : Listen events

' Configuration RabbitMQ
CartRabbitMQConfig ..> CartSagaHandler : Configure queues
InventoryRabbitMQConfig ..> InventorySagaHandler : Configure queues
OrderRabbitMQConfig ..> OrderSagaHandler : Configure queues
NotificationRabbitMQConfig ..> EventConsumer : Configure queues

@enduml